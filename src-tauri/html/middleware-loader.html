<script id="nmd_loader">
  !(function () {
    try {
      if (typeof window === 'undefined' || (typeof window.__TAURI__ === 'undefined' && window.isTauri !== true)) return;

      // 等待Tauri API可用
      function waitForTauriApi() {
        return new Promise((resolve, reject) => {
          let attempts = 0;
          const maxAttempts = 10;
          const interval = setInterval(() => {
            attempts++;
            if (window.__TAURI__ && window.__TAURI__.core && window.__TAURI__.core.invoke) {
              clearInterval(interval);
              resolve();
            } else if (attempts >= maxAttempts) {
              clearInterval(interval);
              reject();
            }
          }, 100);
        });
      }

      async function loadAndInjectHtmlSnippet() {
        try {
          const { invoke } = window.__TAURI__.core;
          let htmlSnippet;
          try {
            // 尝试使用主要 API
            htmlSnippet = await invoke('get_middleware');
          } catch {
            // 如果失败，使用旧的 API 作为后备
            htmlSnippet = await invoke('get_html_injection_snippet');
          }

          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = htmlSnippet;

          const styleElements = tempDiv.querySelectorAll('style');
          styleElements.forEach(styleElement => {
            const newStyle = document.createElement('style');
            newStyle.textContent = styleElement.textContent;
            document.head.appendChild(newStyle);
          });

          const scriptElements = tempDiv.querySelectorAll('script');
          scriptElements.forEach(scriptElement => {
            const newScript = document.createElement('script');
            newScript.textContent = scriptElement.textContent;
            document.body.appendChild(newScript);
          });
        } catch { }
      }

      waitForTauriApi().then(loadAndInjectHtmlSnippet).catch(() => { });
    } finally {
      try {
        const loaderElement = document.getElementById('nmd_loader');
        if (loaderElement && loaderElement.parentNode) {
          loaderElement.parentNode.removeChild(loaderElement);
        }
      } catch { }
    }
  })();
</script>