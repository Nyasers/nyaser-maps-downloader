<!-- Nyaser Maps Downloader Interceptor HTML Fragment -->
<style>
  /* 下载任务容器 */
  .nmd-container {
    position: fixed;
    bottom: 20px;
    left: 20px;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  /* 单个下载任务组件 */
  .nmd-task {
    background: rgba(0, 0, 0, 0.8);
    color: white;
    border-radius: 5px;
    padding: 10px 15px;
    min-width: 300px;
    font-family: Arial, sans-serif;
    font-size: 14px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    transition: opacity 0.3s ease;
  }

  /* 任务头部 */
  .nmd-task-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }

  /* 文件名 */
  .nmd-task-filename {
    font-weight: bold;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* 任务状态 */
  .nmd-task-status {
    margin-left: 10px;
    font-size: 12px;
    opacity: 0.8;
  }

  /* 进度条容器 */
  .nmd-progress {
    width: 100%;
    height: 4px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 2px;
    overflow: hidden;
  }

  /* 进度条 */
  .nmd-progress-bar {
    height: 100%;
    background: #4CAF50;
    width: 0%;
    transition: width 0.1s ease;
    border-radius: 2px;
  }

  /* 进度百分比 */
  .nmd-progress-text {
    font-size: 12px;
    opacity: 0.8;
    text-align: right;
    margin-top: 4px;
  }

  /* 原始aria2c输出 */
  .nmd-raw-output {
    font-size: 11px;
    color: #888;
    margin-top: 4px;
    padding: 4px 8px;
    background: rgba(0, 0, 0, 0.1);
    border-radius: 3px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* 警告通知 */
  .nmd-warning {
    position: fixed;
    bottom: 20px;
    right: 20px;
    padding: 10px 20px;
    background: rgba(255, 152, 0, 0.9);
    color: white;
    border-radius: 5px;
    z-index: 9998;
    max-width: 300px;
    font-family: Arial, sans-serif;
    font-size: 14px;
    display: none;
  }
</style>
<script>
  !function () {
    try {

      // 创建下载任务容器和警告通知元素
      const downloadsContainer = document.createElement('div');
      downloadsContainer.className = 'nmd-container';
      document.body.appendChild(downloadsContainer);

      const warningDisplay = document.createElement('div');
      warningDisplay.className = 'nmd-warning';
      document.body.appendChild(warningDisplay);

      // 存储当前活动的下载任务
      const activeTasks = new Map();

      // 创建下载任务元素的函数
      function createTaskElement(taskId, filename, initialStatus = '准备下载...') {
        // 创建任务容器
        const taskElement = document.createElement('div');
        taskElement.className = 'nmd-task';
        taskElement.dataset.taskId = taskId;

        // 创建任务头部
        const taskHeader = document.createElement('div');
        taskHeader.className = 'nmd-task-header';

        // 创建文件名显示
        const filenameElement = document.createElement('div');
        filenameElement.className = 'nmd-task-filename';
        filenameElement.textContent = filename;

        // 创建状态显示
        const statusElement = document.createElement('div');
        statusElement.className = 'nmd-task-status';
        statusElement.textContent = initialStatus;

        // 创建进度条容器
        const progressContainer = document.createElement('div');
        progressContainer.className = 'nmd-progress';

        // 创建进度条
        const progressBar = document.createElement('div');
        progressBar.className = 'nmd-progress-bar';

        // 创建进度百分比
        const progressText = document.createElement('div');
        progressText.className = 'nmd-progress-text';
        progressText.textContent = '0%';

        // 创建原始aria2c输出显示
        const rawOutputElement = document.createElement('div');
        rawOutputElement.className = 'nmd-raw-output';
        rawOutputElement.textContent = ''; // 初始为空

        // 组装元素
        taskHeader.appendChild(filenameElement);
        taskHeader.appendChild(statusElement);
        progressContainer.appendChild(progressBar);
        taskElement.appendChild(taskHeader);
        taskElement.appendChild(progressContainer);
        taskElement.appendChild(progressText);
        taskElement.appendChild(rawOutputElement);

        // 添加到容器
        downloadsContainer.appendChild(taskElement);

        // 返回创建的元素引用
        return {
          element: taskElement,
          filename: filenameElement,
          status: statusElement,
          progress: progressBar,
          progressText: progressText,
          rawOutput: rawOutputElement
        };
      }

      // 移除下载任务元素的函数
      function removeTaskElement(taskId) {
        const task = activeTasks.get(taskId);
        if (task) {
          // 添加淡出动画
          task.element.style.opacity = '0';
          setTimeout(() => {
            if (task.element.parentNode) {
              task.element.parentNode.removeChild(task.element);
            }
            activeTasks.delete(taskId);

            // 同时从lastUpdateTimes中删除
            if (typeof lastUpdateTimes !== 'undefined') {
              lastUpdateTimes.delete(taskId);
            }

            // 如果没有活动任务，隐藏容器
            if (activeTasks.size === 0) {
              downloadsContainer.style.display = 'none';
            }
          }, 300);
        }
      }

      // 等待全局TAURI对象可用的函数
      function waitForTauri() {
        return new Promise((resolve) => {
          let attempts = 0;
          const maxAttempts = 10;
          const checkInterval = setInterval(() => {
            attempts++;
            if (window.__TAURI__ && window.__TAURI__.core && window.__TAURI__.core.invoke && window.__TAURI__.event && window.__TAURI__.event.listen) {
              clearInterval(checkInterval);
              resolve(true);
            } else if (attempts >= maxAttempts) {
              clearInterval(checkInterval);
              resolve(false);
            }
          }, 100);
        });
      }

      // 检测到Tauri环境，静默启动

      // 选择要观察的目标节点（这里是 #root 元素）
      const targetNode = document.getElementById('root');

      // 配置观察器需要观察的变动类型
      const config = { childList: true, subtree: true };

      // 创建一个回调函数来处理DOM变动
      const callback = (mutationsList, observer) => {
        let loginButtonRemoved = false;

        for (const mutation of mutationsList) {
          if (mutation.type === 'childList') {
            // 尝试移除登录按钮
            try {
              const loginButton = document.querySelector("#root > div.footer.hope-stack > div > a.hope-anchor.inactive");
              if (loginButton) {
                loginButton.remove();
                loginButtonRemoved = true;

                // 同样处理另一个元素
                const anotherElement = document.querySelector("#root > div.footer.hope-stack > div > span");
                if (anotherElement) {
                  anotherElement.remove();
                }
              }
            } catch { }
          }
        }

        // 如果登录按钮已移除，则停止主观察器以优化性能
        if (loginButtonRemoved) {
          observer.disconnect();
        }
      };

      // 创建一个观察器实例
      const observer = new MutationObserver(callback);

      // 开始观察目标节点
      if (targetNode) {
        observer.observe(targetNode, config);
      } else {
        console.error('Nyaser Maps Downloader: 未找到 #root 元素');
      }

      // 创建专门用于Steam按钮的观察器
      function setupSteamButtonObserver() {
        // 配置观察器需要观察的变动类型
        const config = { childList: true };

        // 创建一个回调函数来处理DOM变动
        const steamButtonCallback = (mutationsList, observer) => {
          // 检查是否已经添加了按钮，避免重复添加
          if (document.querySelector("#steam-launch-button")) {
            return; // 按钮已存在，不重复添加
          }

          try {
            // 尝试找到left-toolbar-in元素
            const leftToolbar = document.querySelector("div.left-toolbar-in");
            if (leftToolbar) {
              const settings = document.querySelector("div.left-toolbar-in > svg:nth-child(3)")
              if (settings) {
                // 创建Steam启动按钮
                const rungameid = settings.parentNode.appendChild(settings.cloneNode());
                rungameid.id = "steam-launch-button";
                rungameid.innerHTML = `<path d="M424.8064 0l60.943515 36.615758-61.967515 103.051636h218.329212L673.359127 192.201697 575.706764 372.363636h160.923151c84.743758 0 164.615758 33.978182 224.907637 95.635394A327.059394 327.059394 0 0 1 1055.031855 697.995636v0.496485a327.059394 327.059394 0 0 1-93.494303 229.996606C901.245673 990.145939 821.280582 1024 736.505794 1024H318.403491c-84.743758 0-164.615758-33.978182-224.907636-95.635394A326.997333 326.997333 0 0 1 0.001552 698.492121v-0.496485a327.059394 327.059394 0 0 1 93.494303-229.996606C153.787733 406.341818 233.659733 372.363636 318.403491 372.363636h176.469333l87.505455-161.512727h-221.525334l-30.409697-53.992727L424.83743 0zM736.660945 455.959273H318.372461c-130.451394 0-236.668121 108.606061-236.668122 242.036363v0.496485c0 133.430303 106.216727 242.036364 236.668122 242.036364H736.660945c130.451394 0 236.668121-108.606061 236.668122-242.036364v-0.496485c0-133.430303-106.216727-242.036364-236.668122-242.036363z m-51.386181 138.457212A90.608485 90.608485 0 0 1 775.759127 685.08703 90.608485 90.608485 0 0 1 685.243733 775.757576a90.701576 90.701576 0 0 1 0-181.341091z m-405.566061 9.18497l62.681212 0.155151L342.172703 651.636364H403.395491v93.090909h-61.377939l-0.062061 21.938424L279.274279 766.510545 279.336339 744.727273H248.243976v-93.090909h31.278545l0.124121-48.034909z m405.566061 43.442424c-20.976485 0-38.105212 17.159758-38.105212 38.167273 0 21.007515 17.128727 38.167273 38.105212 38.167272a38.167273 38.167273 0 1 0 0-76.334545z" fill="#1890ff" p-id="1755"></path>`

                // 添加点击事件处理
                rungameid.addEventListener("click", (event) => {
                  event.stopPropagation(); // 阻止事件冒泡
                  location.href = 'steam://rungameid/550';
                });

                // 创建服务器列表按钮
                const serverListButton = settings.parentNode.appendChild(settings.cloneNode());
                serverListButton.id = "server-list-button";
                serverListButton.innerHTML = `<path d="M864 138.666667v768h-704v-768h704z m-64 533.333333h-576v170.666667h576v-170.666667zM704 725.333333v64h-128v-64h128z m96-288h-576v170.666667h576v-170.666667zM704 490.666667v64h-128v-64h128z m96-288h-576v170.666666h576v-170.666666zM704 256v64h-128v-64h128z" fill="#1890ff" p-id="4714"></path>`;

                // 添加点击事件处理
                serverListButton.addEventListener("click", async (event) => {
                  event.stopPropagation(); // 阻止事件冒泡
                  try {
                    if (window.__TAURI__?.core?.invoke) {
                      console.log('Nyaser Maps Downloader: 调用后端open_server_list_window命令');
                      await window.__TAURI__.core.invoke('open_server_list_window');
                    } else {
                      console.error('Nyaser Maps Downloader: Tauri invoke API不可用');
                    }
                  } catch (e) {
                    console.error('Nyaser Maps Downloader: 打开服务器列表窗口时出错:', e);
                  }
                });

                // 创建文件管理器按钮
                const fileManagerButton = settings.parentNode.appendChild(settings.cloneNode());
                fileManagerButton.id = "file-manager-button";
                fileManagerButton.innerHTML = `<path d="M98 351c-17.7 0-32-14.3-32-32V192.8c0-52.9 43.1-96 96-96h221c52.9 0 96 43.1 96 96V255c0 17.7-14.3 32-32 32s-32-14.3-32-32v-62.2c0-17.6-14.4-32-32-32H162c-17.6 0-32 14.4-32 32V319c0 17.6-14.3 32-32 32z" fill="#1890ff" p-id="4791"></path><path d="M864 926.6H383c-17.7 0-32-14.3-32-32s14.3-32 32-32h481c17.6 0 32-14.4 32-32V319c0-17.6-14.4-32-32-32H447c-17.7 0-32-14.3-32-32s14.3-32 32-32h417c52.9 0 96 43.1 96 96v511.7c0 52.9-43.1 95.9-96 95.9z" fill="#1890ff" p-id="4792"></path><path d="M383 926.6H162c-52.9 0-96-43.1-96-96V319c0-17.7 14.3-32 32-32s32 14.3 32 32v511.7c0 17.6 14.4 32 32 32h221c17.7 0 32 14.3 32 32 0 17.6-14.3 31.9-32 31.9zM768.1 511.2H256c-17.7 0-32-14.3-32-32s14.3-32 32-32h512.1c17.7 0 32 14.3 32 32s-14.3 32-32 32z" fill="#1890ff" p-id="4793"></path><path d="M768.1 703H256c-17.7 0-32-14.3-32-32s14.3-32 32-32h512.1c17.7 0 32 14.3 32 32s-14.3 32-32 32z" fill="#1890ff" p-id="4794"></path>`;

                // 添加点击事件处理
                fileManagerButton.addEventListener("click", async (event) => {
                  event.stopPropagation(); // 阻止事件冒泡
                  try {
                    if (window.__TAURI__?.core?.invoke) {
                      console.log('Nyaser Maps Downloader: 调用后端open_file_manager_window命令');
                      await window.__TAURI__.core.invoke('open_file_manager_window');
                    } else {
                      console.error('Nyaser Maps Downloader: Tauri invoke API不可用');
                    }
                  } catch (e) {
                    console.error('Nyaser Maps Downloader: 打开文件管理器窗口时出错:', e);
                  }
                });
              }
            }
          } catch (e) {
            console.error('Nyaser Maps Downloader: 添加按钮时出错:', e);
          }
        };

        // 创建一个观察器实例
        const steamObserver = new MutationObserver(steamButtonCallback);

        // 查找left-toolbar-box元素作为观察目标
        const findLeftToolbarBoxAndObserve = () => {
          const leftToolbarBox = document.querySelector("div.left-toolbar-box");
          if (leftToolbarBox) {
            // 观察left-toolbar-box元素，只观察childList变动以优化性能
            steamObserver.observe(leftToolbarBox, config);
            // 立即检查一次当前状态
            steamButtonCallback([], steamObserver);
          } else {
            // 如果left-toolbar-box元素不存在，先观察body元素
            steamObserver.observe(document.body, { childList: true, subtree: true });
            // 稍后再次尝试查找left-toolbar-box元素
            setTimeout(() => {
              const newLeftToolbarBox = document.querySelector("div.left-toolbar-box");
              if (newLeftToolbarBox) {
                // 切换观察目标到left-toolbar-box元素
                steamObserver.disconnect();
                steamObserver.observe(newLeftToolbarBox, config);
              }
            }, 500);
          }
        };

        // 启动观察
        findLeftToolbarBoxAndObserve();
      }

      // 保存原始的window.open函数引用，用于绕过拦截器
      const originalWindowOpen = window.open;

      // 启动Steam按钮观察器
      setupSteamButtonObserver();

      // 简化版的按钮观察器
      function setupButtonObserver() {
        // 配置观察器需要观察的变动类型
        const config = { childList: true, subtree: true };

        // 创建一个回调函数来处理DOM变动
        const buttonCallback = (mutationsList, observer) => {
          try {
            // 1. 尝试找到第一个目标按钮 - 改为"安装"
            const installButton = document.querySelector("div.fileinfo > div:nth-child(3) > div > a");
            if (installButton && installButton.textContent !== '安装') {
              // 将按钮文本改为"安装"
              installButton.textContent = '安装';
              console.log('Nyaser Maps Downloader: 成功修改按钮文本为"安装"');
            }

            // 2. 尝试找到第二个目标按钮 - 复制链接按钮改为"下载"
            const copyLinkButton = document.querySelector("div.fileinfo > div:nth-child(3) > div > button");
            if (copyLinkButton && copyLinkButton.textContent !== '下载') {
              // 将按钮文本改为"下载"
              copyLinkButton.textContent = '下载';

              // 移除原有的点击事件监听器并创建新按钮
              const newButton = copyLinkButton.cloneNode(true);
              copyLinkButton.parentNode.replaceChild(newButton, copyLinkButton);

              // 添加新的点击事件处理器，使用捕获阶段确保优先处理
              newButton.addEventListener('click', function (event) {
                // 尝试获取链接
                const linkElement = document.querySelector("div.fileinfo > div:nth-child(3) > div > a");
                if (linkElement && linkElement.href) {
                  try {
                    console.log('Nyaser Maps Downloader: 点击下载按钮，链接地址:', linkElement.href);

                    // 使用Tauri invoke调用后端的open_external_link命令
                    if (window.__TAURI__?.core?.invoke) {
                      console.log('Nyaser Maps Downloader: 调用后端open_external_link命令');
                      window.__TAURI__.core.invoke('open_external_link', {
                        url: linkElement.href
                      }).then(result => {
                        console.log('Nyaser Maps Downloader: 链接打开结果:', result);
                      }).catch(err => {
                        console.error('Nyaser Maps Downloader: 调用后端命令时出错:', err);
                      });
                    } else {
                      console.error('Nyaser Maps Downloader: Tauri invoke API不可用');
                    }
                  } catch (e) {
                    console.error('Nyaser Maps Downloader: 处理点击事件时出错:', e.message, e.stack);
                  }
                } else {
                  console.error('Nyaser Maps Downloader: 未找到链接元素或链接地址');
                }
              }, true); // 使用true参数在捕获阶段执行

              console.log('Nyaser Maps Downloader: 成功修改复制链接按钮为"下载"');
            }
          } catch (e) {
            console.error('Nyaser Maps Downloader: 修改按钮时出错:', e);
          }
        };

        // 创建一个观察器实例
        const buttonObserver = new MutationObserver(buttonCallback);

        // 开始观察body元素
        if (document.body) {
          buttonObserver.observe(document.body, config);
          // 立即检查一次当前状态
          buttonCallback([], buttonObserver);
        }
      }

      waitForTauri().then(tauriReady => {
        if (!tauriReady) {
          console.error('Nyaser Maps Downloader: Tauri API未能完全初始化');
          return;
        }

        // 提取invoke和event API
        const { invoke } = window.__TAURI__.core;
        const { listen, once } = window.__TAURI__.event;

        // 提取shell API
        if (window.__TAURI__?.shell?.open) {
          shellAPI = window.__TAURI__.shell.open;
          console.log('Nyaser Maps Downloader: 成功初始化shell API');
        }

        // 初始化完成后再启动按钮观察器
        setupButtonObserver();

        // 准备注册事件监听器

        // 存储任务最后更新时间的映射
        const lastUpdateTimes = new Map();

        // 检查并移除长时间无响应的下载任务
        function checkStalledDownloads() {
          const currentTime = Date.now();
          const stallThreshold = 30000; // 30秒无更新则视为停滞

          activeTasks.forEach((task, taskId) => {
            const lastUpdateTime = lastUpdateTimes.get(taskId);
            if (lastUpdateTime && currentTime - lastUpdateTime > stallThreshold) {
              // 更新状态为下载中断
              task.status.textContent = '下载中断';
              task.progress.style.background = '#ff9800'; // 橙色背景表示警告

              // 再显示5秒后移除
              setTimeout(() => {
                removeTaskElement(taskId);
                lastUpdateTimes.delete(taskId);
              }, 5000);
            }
          });
        }

        // 每5秒检查一次停滞的下载任务
        setInterval(checkStalledDownloads, 5000);

        // 监听下载进度事件
        const progressUnlisten = listen('download-progress', (event) => {
          // 接收到进度事件
          const { progress, filename, taskId, rawOutput } = event.payload;
          // 对文件名进行URL解码
          const decodedFilename = filename ? decodeURIComponent(filename) : '未知文件';

          // 确保容器可见
          downloadsContainer.style.display = 'flex';

          // 获取或创建任务元素
          let task;
          if (activeTasks.has(taskId)) {
            task = activeTasks.get(taskId);
          } else {
            task = createTaskElement(taskId, decodedFilename, '正在下载...');
            activeTasks.set(taskId, task);
          }

          // 更新最后活动时间
          lastUpdateTimes.set(taskId, Date.now());

          // 更新进度信息
          const progressPercent = progress.toFixed(1); // 保留一位小数
          task.progress.style.width = `${progressPercent}%`;
          task.progressText.textContent = `${progressPercent}%`;
          task.status.textContent = '正在下载...';

          // 更新原始aria2c输出信息
          if (rawOutput && task.rawOutput) {
            task.rawOutput.textContent = rawOutput;
          }
        });

        // 进度事件监听器注册成功

        // 监听下载完成事件（仅表示下载完成，解压还未开始）
        const downloadedUnlisten = listen('download-complete', (event) => {
          // 接收到下载完成事件
          const { filename, success, message, taskId } = event.payload || {};
          if (!taskId) return; // 如果没有taskId，忽略此事件

          // 对文件名进行URL解码
          const decodedFilename = filename ? decodeURIComponent(filename) : '未知文件';

          // 获取任务元素
          const task = activeTasks.get(taskId);
          if (task && success) {
            // 更新任务状态为下载完成，准备解压
            task.status.textContent = '等待解压';
            task.progress.style.width = '100%';
            task.progressText.textContent = '100%';
            // 在控制台输出下载完成信息
            console.log('Nyaser Maps Downloader: 文件下载完成，准备解压:', message);
          }
        });

        // 监听解压开始事件
        const extractStartUnlisten = listen('extract-start', (event) => {
          // 接收到解压开始事件
          const { filename, taskId, extractDir } = event.payload || {};
          if (!taskId) return; // 如果没有taskId，忽略此事件

          // 对文件名进行URL解码
          const decodedFilename = filename ? decodeURIComponent(filename) : '未知文件';

          // 获取任务元素
          const task = activeTasks.get(taskId);
          if (task) {
            // 更新任务状态为解压中
            task.status.textContent = '解压中';
            // 在控制台输出解压开始信息
            console.log('Nyaser Maps Downloader: 开始解压文件:', decodedFilename, '到目录:', extractDir);
          }
        });

        // 监听解压进度事件
        const extractProgressUnlisten = listen('extract-progress', (event) => {
          // 接收到解压进度事件
          const { progress, filename, taskId, rawOutput } = event.payload || {};
          if (!taskId) return; // 如果没有taskId，忽略此事件

          // 对文件名进行URL解码
          const decodedFilename = filename ? decodeURIComponent(filename) : '未知文件';

          // 确保容器可见
          downloadsContainer.style.display = 'flex';

          // 获取任务元素
          const task = activeTasks.get(taskId);
          if (task) {
            // 更新最后活动时间
            lastUpdateTimes.set(taskId, Date.now());

            // 更新进度信息
            const progressPercent = progress.toFixed(1); // 保留一位小数
            task.progress.style.width = `${progressPercent}%`;
            task.progressText.textContent = `${progressPercent}%`;
            task.status.textContent = '解压中';

            // 更新原始输出信息
            if (rawOutput && task.rawOutput) {
              task.rawOutput.textContent = rawOutput;
            }
          }
        });

        // 监听解压完成事件
        const completeUnlisten = listen('extract-complete', (event) => {
          // 接收到解压完成事件
          const { filename, success, message, taskId } = event.payload || {};
          if (!taskId) return; // 如果没有taskId，忽略此事件

          // 对文件名进行URL解码
          const decodedFilename = filename ? decodeURIComponent(filename) : '未知文件';

          // 获取任务元素
          const task = activeTasks.get(taskId);
          if (task) {
            // 更新任务状态
            if (success) {
              task.status.textContent = '解压完成';
              // 在控制台输出解压路径
              console.log('Nyaser Maps Downloader: 文件解压完成，解压路径:', message);
            } else {
              task.status.textContent = '解压失败';
              task.progress.style.background = '#f44336';
              // 在控制台输出错误信息
              console.error('Nyaser Maps Downloader: 解压失败:', message);
            }

            // 延迟5秒后移除任务显示
            setTimeout(() => {
              removeTaskElement(taskId);
            }, 5e3);
          }
        });

        // 监听下载任务开始事件
        const taskStartUnlisten = listen('download-task-start', (event) => {
          // 接收到下载任务开始事件
          const { taskId, filename, url } = event.payload || {};
          if (!taskId) return; // 如果没有taskId，忽略此事件

          // 对文件名进行URL解码
          const decodedFilename = filename ? decodeURIComponent(filename) : '未知文件';

          // 确保容器可见
          downloadsContainer.style.display = 'flex';

          // 创建新的任务元素
          const task = createTaskElement(taskId, decodedFilename, '准备下载');
          activeTasks.set(taskId, task);

          // 在控制台输出任务开始信息
          console.log('Nyaser Maps Downloader: 开始下载任务:', taskId, decodedFilename);
        });

        // 监听下载任务添加事件
        const taskAddUnlisten = listen('download-task-add', (event) => {
          // 接收到下载任务添加事件
          const { taskId, filename, url } = event.payload || {};
          if (!taskId) return; // 如果没有taskId，忽略此事件

          // 对文件名进行URL解码
          const decodedFilename = filename ? decodeURIComponent(filename) : '未知文件';

          // 在控制台输出任务添加信息
          console.log('Nyaser Maps Downloader: 任务添加到队列:', taskId, decodedFilename);
        });

        // 监听下载队列更新事件
        const queueUpdateUnlisten = listen('download-queue-update', (event) => {
          // 接收到下载队列更新事件
          const { queue } = event.payload || {};
          if (!queue) return; // 如果没有queue信息，忽略此事件

          const { waiting_tasks, total_tasks, active_tasks } = queue;

          // 在控制台输出队列更新信息
          console.log('Nyaser Maps Downloader: 队列更新 - 等待任务数:', waiting_tasks,
            '总任务数:', total_tasks, '活跃任务数:', active_tasks);
        });

        // 监听目录更改事件
        const dirChangedUnlisten = listen('extract-dir-changed', (event) => {
          // 接收到目录更改事件
          const { newDir, success } = event.payload;

          if (newDir) {
            // 在控制台输出解压路径
            console.log('Nyaser Maps Downloader: 解压路径:', newDir);
          }
        });

        // 监听游戏目录警告事件
        const gameDirWarningUnlisten = listen('game-dir-warning', (event) => {
          // 游戏目录警告
          const { message } = event.payload;

          // 显示警告信息
          warningDisplay.textContent = '警告: ' + message;
          warningDisplay.style.display = 'block';

          // 8秒后自动隐藏警告，让用户有足够时间阅读警告信息
          setTimeout(() => {
            warningDisplay.style.display = 'none';
          }, 8000);
        });

        // 监听下载失败事件
        const downloadFailedUnlisten = listen('download-failed', (event) => {
          // 接收到下载失败事件
          const { taskId, filename, error } = event.payload || {};
          if (!taskId) return; // 如果没有taskId，忽略此事件

          // 对文件名进行URL解码
          const decodedFilename = filename ? decodeURIComponent(filename) : '未知文件';

          // 获取任务元素
          const task = activeTasks.get(taskId);
          if (task) {
            // 更新任务状态为下载失败
            task.status.textContent = '下载失败';
            task.progress.style.background = '#f44336'; // 红色背景表示错误

            // 在控制台输出错误信息
            console.error('Nyaser Maps Downloader: 下载失败:', decodedFilename, '错误:', error);

            // 10秒后自动隐藏错误提示
            setTimeout(() => {
              removeTaskElement(taskId);
            }, 10000);
          } else {
            // 如果没有找到任务元素，创建一个新的错误提示
            warningDisplay.textContent = '下载失败: ' + decodedFilename + ' - ' + error;
            warningDisplay.style.display = 'block';
            warningDisplay.style.background = '#f44336'; // 红色背景表示错误

            // 10秒后自动隐藏警告
            setTimeout(() => {
              warningDisplay.style.display = 'none';
              warningDisplay.style.background = '#ff9800'; // 恢复橙色背景
            }, 10000);
          }
        });

        // 完成事件监听器注册成功

        // 添加窗口关闭时清理监听器的逻辑
        window.addEventListener('beforeunload', () => {
          // 清理事件监听器
          progressUnlisten();
          downloadedUnlisten();
          extractStartUnlisten();
          completeUnlisten();
          taskStartUnlisten();
          downloadFailedUnlisten();
          taskAddUnlisten();
          queueUpdateUnlisten();
          dirChangedUnlisten();
          gameDirWarningUnlisten();
        });

        // 将下载链接传递给后端处理
        async function handleDownloadLink(url) {
          try {
            // 将下载链接传递给后端处理

            // 尝试调用新的download函数，如果失败则回退到旧的download_and_extract_with_dialog函数
            // 这样可以实现HTML文件对新老版本的兼容性
            let result;
            try {
              // 首先尝试调用新版本的download函数
              result = await invoke('download', {
                url: url
              });
            } catch (newError) {
              // 如果调用失败，尝试回退到旧版本的download_and_extract_with_dialog函数
              try {
                result = await invoke('download_and_extract_with_dialog', {
                  url: url
                });
              } catch (oldError) {
                // 两个函数都调用失败，抛出错误
                throw newError; // 优先抛出新版本的错误信息
              }
            };

            // 不在这里直接显示解压状态，而是等待后端发送解压事件
            // 下载请求已发送到后端

            // 移除所有自动显示解压完成的代码，完全由后端事件驱动更新UI
            return true;
          } catch (error) {
            console.error('Nyaser Maps Downloader: 处理下载链接失败:', error);
            // 为依赖错误提供更详细的帮助信息
            let errorMessage = error.message || '未知错误';

            // 显示错误警告信息
            warningDisplay.textContent = '错误: 下载失败 - ' + errorMessage;
            warningDisplay.style.display = 'block';
            warningDisplay.style.background = 'rgba(244, 67, 54, 0.9)'; // 红色背景表示错误

            // 10秒后自动隐藏错误警告
            setTimeout(() => {
              warningDisplay.style.display = 'none';
              warningDisplay.style.background = 'rgba(255, 152, 0, 0.9)'; // 恢复橙色背景
            }, 10000);

            return false;
          }
        }

        // 检测是否为下载链接
        function isDownloadLink(url) {
          if (!url) return false;

          // 检查是否为特定域名下的下载链接
          if (url.startsWith('https://maps.nyase.ru/d/') ||
            url.startsWith('https://maps.nyase.ru/p/') ||
            url.endsWith('.7z')) {
            return true;
          }

          return false;
        }

        // 设置链接拦截
        function setupLinkInterceptor() {
          // 正在设置链接拦截器

          // 1. 拦截全局点击事件，只检查A标签
          document.addEventListener('click', async (event) => {
            // 检查A标签
            let target = event.target;
            while (target && target.tagName !== 'A') {
              target = target.parentElement;
            }

            if (target && target.tagName === 'A') {
              const href = target.getAttribute('href');
              if (href && isDownloadLink(href)) {
                // 阻止默认行为
                event.preventDefault();
                event.stopPropagation();

                // 拦截到下载链接(点击A标签)

                // 直接传递给后端处理
                await handleDownloadLink(href);
              }
            }
          }, true);

          // 2. 拦截window.open调用
          const originalOpen = window.open;
          window.open = function (url, target, features) {
            if (url && isDownloadLink(url)) {
              // 拦截到下载链接(window.open)
              // 使用立即执行的方式避免阻塞
              (async () => {
                await handleDownloadLink(url);
              })();
              return null; // 阻止原始窗口打开
            }
            return originalOpen.apply(this, arguments);
          };

          // 下载链接拦截器已设置完成
        }

        // 初始化拦截器
        setupLinkInterceptor();

        // 导出公共API
        window.NyaserMapsDownloader = {
          handleDownloadLink,
          isDownloadLink,
          setupLinkInterceptor
        };
      });

    } catch (error) {
      if (typeof console !== 'undefined') {
        console.error('Nyaser Maps Downloader: 初始化失败:', error);
      }
    }
  }();
</script>
<!-- End of Nyaser Maps Downloader Interceptor -->