<script id="nmd_loader">
  !(function () {
    function replace() {
      const qrBtn = document.querySelectorAll('div.fileinfo > div:nth-child(3) > div > button')[1];
      if (!qrBtn) return;

      /* 1. 克隆并清理 */
      const neo = qrBtn.cloneNode(true);
      neo.classList.remove('hope-icon-button'); // 去掉固定正方形元凶
      neo.textContent = '打开';                 // 换字

      /* 2. 清空所有旧监听器（Hope 的 popover 等） */
      neo.replaceWith(neo.cloneNode(true));     // 暴力移除所有监听

      /* 3. 挂新跳转 */
      neo.addEventListener('click', () => {
        location.href = 'nmd://open' + location.pathname;
      });

      /* 4. 原地替换 */
      qrBtn.parentNode.replaceChild(neo, qrBtn);
    }

    function remove() {
      const qrBtn = document.querySelectorAll('div.fileinfo > div:nth-child(3) > div > button')[1];
      if (qrBtn) qrBtn.parentNode.removeChild(qrBtn);
    }

    var listening = false;
    function setupObserverOrigin(job) {
      if (listening) return; else listening = true;
      const TARGET = 'div.fileinfo > div:nth-child(3) > div';
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (listening && mutation.type === 'childList') {
            const targetElement = document.querySelector(TARGET);
            if (targetElement) {
              job();
              observer.disconnect();
              listening = false;
              console.log('停止监听DOM变化');
              const refresh = document.querySelector("svg[tips=refresh]");
              if (refresh && !refresh.onclick) {
                console.log(refresh);
                refresh.onclick = setupObserverOrigin.bind(null, job);
              }
            }
          }
        });
      });
      try {
        observer.observe(document.body, { childList: true, subtree: true });
        console.log('开始监听DOM变化');
      } catch (error) {
        listening = false;
        console.error('DOM观察器配置失败:', error);
      }
    }

    var failed = false;

    try {
      if (typeof window === 'undefined' || (typeof window.__TAURI__ === 'undefined' && window.isTauri !== true)) throw new Error();

      // 等待Tauri API可用
      function waitForTauriApi() {
        return new Promise((resolve, reject) => {
          let attempts = 0;
          const maxAttempts = 10;
          const interval = setInterval(() => {
            attempts++;
            if (window.__TAURI__ && window.__TAURI__.core && window.__TAURI__.core.invoke) {
              clearInterval(interval);
              resolve();
            } else if (attempts >= maxAttempts) {
              clearInterval(interval);
              reject();
            }
          }, 100);
        });
      }

      async function loadAndInjectHtmlSnippet() {
        try {
          const { invoke } = window.__TAURI__.core;

          const htmlSnippet = await invoke('get_middleware');

          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = htmlSnippet;

          const styleElements = tempDiv.querySelectorAll('style');
          styleElements.forEach(styleElement => {
            const newStyle = document.createElement('style');
            newStyle.textContent = styleElement.textContent;
            document.head.appendChild(newStyle);
          });

          const scriptElements = tempDiv.querySelectorAll('script');
          scriptElements.forEach(scriptElement => {
            const newScript = document.createElement('script');
            newScript.textContent = scriptElement.textContent;
            document.body.appendChild(newScript);
          });
        } catch { }
      }
      waitForTauriApi().then(loadAndInjectHtmlSnippet).catch(() => { throw new Error() });
    } catch (error) {
      failed = true;
    } finally {
      const setupObserver = setupObserverOrigin.bind(null, failed ? replace : remove);

      ['DOMContentLoaded', 'popstate'].forEach(event => {
        window.addEventListener(event, setupObserver);
      });

      ['pushState', 'replaceState'].forEach(event => {
        window.history[event] = new Proxy(window.history[event], {
          apply: (target, thisArg, argumentsList) => {
            const result = Reflect.apply(target, thisArg, argumentsList);
            setupObserver();
            return result;
          }
        });
      });

      setupObserver();

      try {
        const loaderElement = document.getElementById('nmd_loader');
        if (loaderElement && loaderElement.parentNode) {
          loaderElement.parentNode.removeChild(loaderElement);
        }
      } catch { }
    }
  })();
</script>