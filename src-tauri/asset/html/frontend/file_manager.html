<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文件管理器 - Nyaser Maps Downloader</title>

    <!-- 隐藏的HTML模板 -->
    <template id="groupItemTemplate">
        <div class="group-item">
            <div class="group-header" data-group="{{groupKey}}">
                <div class="group-checkbox-container">
                    <label class="file-checkbox-container">
                        <input type="checkbox" class="group-checkbox" data-group="{{groupKey}}">
                        <span class="checkbox-custom"></span>
                    </label>
                    <span class="group-toggle">▶</span>
                </div>
                <div class="group-info">{{displayGroupName}}</div>
                <div class="group-stats">{{fileCount}} 个文件 · {{totalSize}}</div>
                <div class="group-actions"></div>
                <button class="delete-btn group-delete-btn" data-group="{{groupKey}}">删除</button>
            </div>
            <div class="group-content" id="{{groupId}}">
                <div class="group-files">
                    <!-- 文件项将动态插入这里 -->
                </div>
            </div>
        </div>
    </template>

    <template id="fileItemTemplate">
        <div class="file-item" data-group="{{groupKey}}">
            <div class="file-name">{{displayName}}</div>
            <div class="file-size">{{fileSize}}</div>
        </div>
    </template>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            color: #333;
            background-color: #f5f5f5;
        }

        h1 {
            color: #4CAF50;
            margin-bottom: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .file-list {
            margin-top: 20px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .file-item.selected {
            background-color: #e3f2fd;
        }

        .file-checkbox-container {
            position: relative;
            padding-left: 25px;
            margin-right: 10px;
            cursor: pointer;
            display: inline-block;
            height: 20px;
            line-height: 20px;
        }

        /* 隐藏原生复选框 */
        .file-checkbox-container input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }

        /* 自定义复选框样式 */
        .checkbox-custom {
            position: absolute;
            top: 50%;
            left: 0;
            height: 18px;
            width: 18px;
            margin-top: 0px;
            background-color: #eee;
            border-radius: 3px;
            border: 1px solid #ccc;
        }

        /* 鼠标悬停时的样式 */
        .file-checkbox-container:hover input~.checkbox-custom {
            background-color: #ccc;
        }

        /* 选中时的样式 */
        .file-checkbox-container input:checked~.checkbox-custom {
            background-color: #2196F3;
        }

        /* 创建复选标记（默认隐藏） */
        .checkbox-custom:after {
            content: "";
            position: absolute;
            display: none;
        }

        /* 显示复选标记 */
        .file-checkbox-container input:checked~.checkbox-custom:after {
            display: block;
        }

        /* 自定义复选框样式 */
        .file-checkbox-container .checkbox-custom:after {
            left: 5px;
            top: 3px;
            width: 6px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
            display: block;
        }

        /* 分组相关样式 */
        .group-item {
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            transition: box-shadow 0.2s ease;
        }

        .group-item:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
        }

        /* 自定义复选框状态样式 */
        .file-checkbox:checked+.checkbox-custom {
            background-color: #2196F3 !important;
        }

        .file-checkbox:checked+.checkbox-custom:after {
            display: block;
        }

        .group-header {
            background-color: #f5f5f5;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s, border-left-width 0.2s, border-left-color 0.2s;
            border-left: 3px solid transparent;
        }

        .group-header:hover {
            background-color: #eeeeee;
        }

        .group-header.selected {
            background-color: #e3f2fd;
            border-left-color: #2196f3;
            border-left-width: 3px;
        }

        .group-toggle {
            cursor: pointer;
            font-size: 14px;
            margin-left: 5px;
            transition: transform 0.2s ease;
        }

        .group-toggle.expanded {
            transform: rotate(90deg);
            transition: transform 0.2s ease;
        }

        .group-info {
            flex-grow: 1;
            font-weight: 500;
            font-size: 14px;
        }

        .group-stats {
            color: #666;
            font-size: 12px;
            min-width: 120px;
            white-space: nowrap;
            margin-right: 10px;
        }

        /* 确保删除按钮和统计信息不会重叠 */
        .group-header {
            justify-content: space-between;
        }

        /* 确保统计信息和删除按钮之间有足够的空间 */
        .group-header>div {
            flex-shrink: 0;
        }

        /* 让组名占据剩余空间 */
        .group-info {
            flex-grow: 1;
            min-width: 0;
        }

        .group-content {
            display: none;
            animation: slideDown 0.2s ease-out;
        }

        .group-content.expanded {
            display: block;
            background-color: #fafafa;
            border-top: 1px solid #e0e0e0;
        }

        .group-files {
            padding: 0;
            border-top: 1px solid #e0e0e0;
        }

        .group-checkbox-container {
            display: flex;
            align-items: center;
            margin-right: 10px;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
            }

            to {
                opacity: 1;
                max-height: 1000px;
            }
        }

        /* 分组内文件样式调整 */
        .group-files .file-item {
            padding-left: 65px;
            border-bottom: 1px solid #f0f0f0;
            background-color: white;
        }

        .group-files .file-item:last-child {
            border-bottom: none;
        }

        /* 单文件组样式 */
        .single-file-group {
            background-color: #f9f9f9;
        }

        /* 按钮样式优化 */
        .group-delete-btn,
        .delete-btn {
            transition: all 0.2s ease;
        }

        .group-delete-btn:hover,
        .delete-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* 统一文件项样式 */
        .file-item {
            transition: background-color 0.2s ease;
        }

        .file-item:hover {
            background-color: #f5f5f5 !important;
        }

        .file-checkbox {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }

        /* 统一复选框样式 */
        .checkbox-custom {
            position: absolute;
            top: 50%;
            left: 0;
            height: 18px;
            width: 18px;
            margin-top: -9px;
            background-color: #eee;
            border-radius: 3px;
            border: 1px solid #ccc;
        }

        .file-checkbox-container:hover .checkbox-custom {
            background-color: #ccc;
        }

        .file-checkbox:checked~.checkbox-custom {
            background-color: #2196F3;
        }

        .checkbox-custom:after {
            content: "";
            position: absolute;
            display: none;
        }

        .file-checkbox:checked~.checkbox-custom:after {
            display: block;
        }

        .checkbox-custom:after {
            left: 7px;
            top: 3px;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 3px 3px 0;
            transform: rotate(45deg);
        }

        .file-name {
            flex-grow: 1;
        }

        .file-size {
            margin: 0 10px;
            color: #666;
            font-size: 14px;
        }

        .delete-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }

        .delete-btn:hover {
            background: #d32f2f;
        }

        .batch-delete-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 3px;
            cursor: pointer;
            margin-bottom: 15px;
            margin-left: 10px;
            display: none;
        }

        .batch-delete-btn:hover {
            background: #d32f2f;
        }

        .batch-delete-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .no-files {
            text-align: center;
            color: #666;
            padding: 20px;
            font-style: italic;
        }

        .refresh-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 3px;
            cursor: pointer;
            margin-bottom: 15px;
        }

        .refresh-btn:hover {
            background: #45a049;
        }

        .select-all-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 3px;
            cursor: pointer;
            margin-bottom: 15px;
            margin-left: 10px;
        }

        .select-all-btn:hover {
            background: #0b7dda;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Nyaser Maps Downloader - 文件管理器</h1>
        <p>此窗口显示解压目录下以$nmd_开头的文件：</p>
        <div class="action-buttons">
            <button class="refresh-btn" id="refreshBtn">刷新文件列表</button>
            <button class="select-all-btn" id="selectAllBtn">全选</button>
            <button class="batch-delete-btn" id="batchDeleteBtn" disabled>批量删除</button>
        </div>
        <div class="file-list" id="fileList">
            <p class="no-files">正在加载文件列表...</p>
        </div>
    </div>

    <script>
        const { core, dialog } = window.__TAURI__;
        const { invoke, listen } = core;

        // 检测并分组分p文件
        function groupSplitFiles(files) {
            const groups = new Map(); // 用于存储所有分组（包括单文件组）

            // 为文件添加显示名称和分组键
            files.forEach(file => {
                const displayName = file.name.startsWith('$nmd_') ? file.name.substring(5) : file.name;
                file.displayName = displayName;

                // 尝试提取分组键 - 检测多种分p模式：p1, p2 或 part1, part2 或 cd1, cd2 等
                const groupMatch = displayName.match(/^(.+?)\s*(p|part|cd)\s*(\d+)/i);

                if (groupMatch) {
                    // 提取基础名称（去掉分p部分）作为分组键
                    const baseName = groupMatch[1].trim();
                    if (!groups.has(baseName)) {
                        groups.set(baseName, []);
                    }
                    // 添加到对应分组
                    groups.get(baseName).push(file);
                } else {
                    // 不是分p文件，将其作为单独的分组
                    // 使用文件的完整名称（包含扩展名）作为分组键，确保唯一性
                    groups.set(file.name, [file]);
                }
            });

            // 对每个分组内的文件进行排序
            groups.forEach(files => {
                if (files.length > 1) {
                    // 多文件分组按序号排序
                    files.sort((a, b) => {
                        // 提取序号并进行排序
                        const numA = extractNumber(a.displayName);
                        const numB = extractNumber(b.displayName);
                        return numA - numB;
                    });
                }
                // 单文件分组不需要排序
            });

            // 对所有分组进行排序（按分组名称排序）
            const sortedGroups = new Map([...groups.entries()].sort(([nameA], [nameB]) => {
                // 对分组名进行比较时，去掉扩展名
                const nameAWithoutExt = removeFileExtension(nameA);
                const nameBWithoutExt = removeFileExtension(nameB);
                return nameAWithoutExt.localeCompare(nameBWithoutExt);
            }));

            return { groups: sortedGroups };
        }

        // 从文件名中提取序号用于排序
        function extractNumber(filename) {
            const match = filename.match(/\s*(p|part|cd)\s*(\d+)/i);
            return match ? parseInt(match[2], 10) : 0;
        }

        // 从文件名中移除扩展名（如.vpk）
        function removeFileExtension(filename) {
            const lastDotIndex = filename.lastIndexOf('.');
            return lastDotIndex > 0 ? filename.substring(0, lastDotIndex) : filename;
        }

        // 加载文件列表
        async function loadFileList() {
            try {
                const fileListElement = document.getElementById('fileList');
                fileListElement.innerHTML = '<p class="no-files">正在加载文件列表...</p>';

                const files = await invoke('get_nmd_files');

                if (files && files.length > 0) {
                    // 对文件进行分组
                    const { groups } = groupSplitFiles(files);

                    let html = '';

                    // 渲染所有分组（包括单文件组和多文件组）
                    groups.forEach((groupFiles, groupKey) => {
                        if (groupFiles.length > 0) {
                            // 计算分组总大小
                            const totalSize = groupFiles.reduce((sum, file) => sum + file.size, 0);

                            // 确定是否为单文件组
                            const isSingleFileGroup = groupFiles.length === 1;

                            // 对于单文件组，使用文件名（去掉扩展名）作为显示名称
                            // 对于多文件组，使用分组键作为显示名称
                            const displayGroupName = isSingleFileGroup ? removeFileExtension(groupFiles[0].displayName) : groupKey;

                            // 为分组生成唯一ID
                            const groupId = `group-${encodeURIComponent(groupKey).replace(/[^a-zA-Z0-9]/g, '-')}`;

                            // 使用模板渲染分组项
                            const groupItemTemplate = document.getElementById('groupItemTemplate').innerHTML;
                            const fileItemTemplate = document.getElementById('fileItemTemplate').innerHTML;

                            // 替换模板中的变量
                            let groupHtml = groupItemTemplate
                                .replace(/\{\{groupKey\}\}/g, encodeURIComponent(groupKey))
                                .replace(/\{\{displayGroupName\}\}/g, displayGroupName)
                                .replace(/\{\{fileCount\}\}/g, groupFiles.length)
                                .replace(/\{\{totalSize\}\}/g, formatFileSize(totalSize))
                                .replace(/\{\{groupId\}\}/g, groupId);

                            // 为单文件组添加特定样式
                            if (isSingleFileGroup) {
                                groupHtml = groupHtml.replace('class="group-header"', 'class="group-header single-file-group"');
                            }

                            // 渲染分组内的每个文件
                            let filesHtml = '';
                            groupFiles.forEach(file => {
                                const fileHtml = fileItemTemplate
                                    .replace(/\{\{groupKey\}\}/g, encodeURIComponent(groupKey))
                                    .replace(/\{\{displayName\}\}/g, file.displayName)
                                    .replace(/\{\{fileSize\}\}/g, formatFileSize(file.size));
                                filesHtml += fileHtml;
                            });

                            // 将文件HTML插入到分组HTML中
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = groupHtml;
                            const groupFilesElement = tempDiv.querySelector('.group-files');
                            if (groupFilesElement) {
                                groupFilesElement.innerHTML = filesHtml;
                            }
                            groupHtml = tempDiv.innerHTML;

                            // 将分组HTML添加到总HTML中
                            html += groupHtml;
                        }
                    });

                    fileListElement.innerHTML = html;

                    // 添加分组删除按钮事件监听
                    document.querySelectorAll('.group-delete-btn[data-group]').forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            const groupKey = e.target.getAttribute('data-group');

                            // 直接获取分组内的所有文件项
                            const fileItems = document.querySelectorAll(`.file-item[data-group="${groupKey}"]`);

                            // 确保获取了所有文件
                            if (fileItems.length === 0) {
                                console.error('未找到分组中的文件');
                                return;
                            }

                            // 在实际应用中，这里应该从数据源获取文件名
                            // 由于我们已经渲染了文件名，这里简化处理
                            const fileNames = [];

                            // 遍历文件项来构建文件名列表
                            fileItems.forEach(item => {
                                // 从文件名显示中提取文件名（实际应用中应该从数据源获取）
                                const fileName = '$nmd_' + item.querySelector('.file-name').textContent;
                                fileNames.push(fileName);
                            });

                            // 批量删除整个分组的文件
                            if (fileNames.length > 0) {
                                // 获取显示名称（去掉$nmd_前缀）
                                const displayNames = fileNames.map(name =>
                                    name.startsWith('$nmd_') ? name.substring(5) : name
                                );

                                // 获取分组的显示名称（用于对话框标题）
                                const groupHeader = document.querySelector(`.group-header[data-group="${groupKey}"]`);
                                const groupDisplayName = groupHeader ?
                                    groupHeader.querySelector('.group-info').textContent :
                                    (fileNames.length > 1 ? '文件分组' : removeFileExtension(displayNames[0]));

                                // 显示确认对话框
                                const confirmed = await dialog.confirm(
                                    fileNames.length > 1 ?
                                        `确定要删除 ${groupDisplayName} 分组中的所有 ${fileNames.length} 个文件吗？` :
                                        `确定要删除 "${groupDisplayName}" 吗？`,
                                    {
                                        title: fileNames.length > 1 ? "确认删除分组" : "确认删除文件",
                                        okLabel: "确定",
                                        cancelLabel: "取消"
                                    }
                                );

                                if (confirmed) {
                                    try {
                                        // 逐个删除文件
                                        for (const fileName of fileNames) {
                                            await invoke('delete_nmd_file', { fileName });
                                        }

                                        // 删除后刷新列表
                                        loadFileList();

                                        // 显示删除成功提示
                                        if (fileNames.length > 1) {
                                            await dialog.message(`已成功删除 ${groupDisplayName} 分组中的 ${fileNames.length} 个文件！`, {
                                                kind: 'info',
                                                title: '删除成功'
                                            });
                                        } else {
                                            await dialog.message(`已成功删除文件！`, {
                                                kind: 'info',
                                                title: '删除成功'
                                            });
                                        }
                                    } catch (error) {
                                        console.error('删除文件失败:', error);
                                        // 确保错误信息正确显示
                                        const errorMsg = error.message || JSON.stringify(error);
                                        await dialog.message(`删除文件失败: ${errorMsg}`, {
                                            kind: 'error',
                                            title: '删除失败'
                                        });
                                    }
                                }
                            }
                        });
                    });



                    // 添加分组复选框事件监听
                    document.querySelectorAll('.group-checkbox').forEach(checkbox => {
                        checkbox.addEventListener('change', function () {
                            const groupName = this.getAttribute('data-group');
                            const isChecked = this.checked;

                            // 更新组头样式
                            const groupHeader = document.querySelector(`.group-header[data-group="${groupName}"]`);
                            if (groupHeader) {
                                if (isChecked) {
                                    groupHeader.classList.add('selected');
                                } else {
                                    groupHeader.classList.remove('selected');
                                }
                            }

                            updateSelection();
                        });
                    });



                    // 直接为toggle添加点击事件，这是更直接且可靠的实现方式
                    document.querySelectorAll('.group-toggle').forEach(toggle => {
                        toggle.onclick = function (e) {
                            e.stopPropagation(); // 防止事件冒泡到group-header
                            const groupHeader = this.closest('.group-header');
                            if (groupHeader) {
                                const groupName = groupHeader.getAttribute('data-group');
                                // 注意：这里不需要再次encodeURIComponent，因为data-group已经是编码后的
                                const groupContent = document.getElementById(`group-${groupName.replace(/[^a-zA-Z0-9]/g, '-')}`);
                                if (groupContent) {
                                    if (groupContent.classList.contains('expanded')) {
                                        groupContent.classList.remove('expanded');
                                        this.classList.remove('expanded');
                                    } else {
                                        groupContent.classList.add('expanded');
                                        this.classList.add('expanded');
                                    }
                                }
                            }
                        };
                    });

                    // 默认收起所有分组
                    // 不需要添加expanded类，默认就是收起状态
                    // 为每个分组内容添加transition动画效果
                    document.querySelectorAll('.group-content').forEach(content => {
                        content.style.transition = 'max-height 0.3s ease, opacity 0.3s ease';
                    });

                    // 显示全选按钮
                    document.getElementById('selectAllBtn').style.display = 'inline-block';
                    document.getElementById('batchDeleteBtn').style.display = 'inline-block';
                } else {
                    fileListElement.innerHTML = '<p class="no-files">没有找到以$nmd_开头的文件</p>';
                    // 隐藏全选和批量删除按钮
                    document.getElementById('selectAllBtn').style.display = 'none';
                    document.getElementById('batchDeleteBtn').style.display = 'none';
                }
            } catch (error) {
                console.error('加载文件列表失败:', error);
                document.getElementById('fileList').innerHTML = `<p class="no-files" style="color: red;">加载文件列表失败: ${error.message}</p>`;
                // 隐藏全选和批量删除按钮
                document.getElementById('selectAllBtn').style.display = 'none';
                document.getElementById('batchDeleteBtn').style.display = 'none';
            }
        }

        // 更新分组复选框状态（仅基于组复选框自身状态）
        function updateGroupCheckboxState(groupName) {
            const groupCheckbox = document.querySelector(`.group-checkbox[data-group="${groupName}"]`);
            const groupHeader = document.querySelector(`.group-header[data-group="${groupName}"]`);

            // 确保所有元素都存在
            if (groupCheckbox && groupHeader) {
                if (groupCheckbox.checked) {
                    groupHeader.classList.add('selected');
                } else {
                    groupHeader.classList.remove('selected');
                }
            }
        }



        // 更新选择状态
        function updateSelection() {
            const groupCheckboxes = document.querySelectorAll('.group-checkbox');
            const selectedCount = Array.from(groupCheckboxes).filter(cb => cb.checked).length;
            const batchDeleteBtn = document.getElementById('batchDeleteBtn');
            const selectAllBtn = document.getElementById('selectAllBtn');

            // 更新批量删除按钮状态
            batchDeleteBtn.disabled = selectedCount === 0;

            // 更新全选按钮文本
            if (selectedCount === 0) {
                selectAllBtn.textContent = '全选';
            } else if (selectedCount === groupCheckboxes.length) {
                selectAllBtn.textContent = '取消全选';
            } else {
                selectAllBtn.textContent = '全选';
            }

            // 更新分组头部的选中样式
            document.querySelectorAll('.group-header').forEach(header => {
                const groupCheckbox = header.querySelector('.group-checkbox');
                if (groupCheckbox && groupCheckbox.checked) {
                    header.classList.add('selected');
                } else {
                    header.classList.remove('selected');
                }
            });
        }

        // 全选/取消全选
        function toggleSelectAll() {
            const groupCheckboxes = document.querySelectorAll('.group-checkbox');
            const selectAllBtn = document.getElementById('selectAllBtn');
            const isAllSelected = Array.from(groupCheckboxes).every(cb => cb.checked);

            groupCheckboxes.forEach(checkbox => {
                checkbox.checked = !isAllSelected;
                updateGroupCheckboxState(checkbox.getAttribute('data-group'));
            });

            selectAllBtn.textContent = isAllSelected ? '全选' : '取消全选';
            updateSelection();
        }

        // 批量删除
        async function batchDeleteFiles() {
            const groupCheckboxes = document.querySelectorAll('.group-checkbox:checked');
            let selectedGroups = [];
            let allFileNames = [];

            if (groupCheckboxes.length === 0) return;

            // 收集选中的组信息和文件名
            groupCheckboxes.forEach(groupCheckbox => {
                const groupKey = groupCheckbox.getAttribute('data-group');
                const groupHeader = document.querySelector(`.group-header[data-group="${groupKey}"]`);
                const groupDisplayName = groupHeader ?
                    groupHeader.querySelector('.group-info').textContent :
                    '未命名组';

                selectedGroups.push(groupDisplayName);

                // 在实际应用中，这里应该从数据源获取该分组中的所有文件名
                // 为了简化实现，我们假设每个组对应一个或多个文件
                // 实际应用中应该根据groupKey从数据源获取文件名列表
                // 这里我们使用一种简化的方式来模拟获取文件名
                // 注意：这只是一个临时解决方案
                const fileItems = document.querySelectorAll(`.file-item[data-group="${groupKey}"]`);
                fileItems.forEach(item => {
                    // 从文件名显示中提取文件名（实际应用中应该从数据源获取）
                    const fileName = '$nmd_' + item.querySelector('.file-name').textContent;
                    allFileNames.push(fileName);
                });
            });

            // 显示确认对话框
            const confirmed = await dialog.confirm(
                `确定要删除以下 ${selectedGroups.length} 个组吗？\n${selectedGroups.join('\n')}`,
                {
                    title: "确认批量删除",
                    okLabel: "确定",
                    cancelLabel: "取消"
                }
            );

            if (confirmed) {
                try {
                    // 实际执行删除操作
                    for (const fileName of allFileNames) {
                        await invoke('delete_nmd_file', { fileName });
                    }

                    // 删除后刷新列表
                    loadFileList();

                    // 显示删除成功提示
                    await dialog.message(`已成功删除 ${selectedGroups.length} 个组中的 ${allFileNames.length} 个文件！`, {
                        kind: 'info',
                        title: '删除成功'
                    });
                } catch (error) {
                    console.error('批量删除文件失败:', error);
                    // 确保错误信息正确显示
                    const errorMsg = error.message || JSON.stringify(error);
                    await dialog.message(`批量删除文件失败: ${errorMsg}`, {
                        kind: 'error',
                        title: '删除失败'
                    });
                }
            }
        }

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }



        // 添加键盘Delete键支持
        document.addEventListener('keydown', async (e) => {
            // 当按下Delete键且有选中的组时执行批量删除
            if (e.key === 'Delete' || e.key === 'Backspace') {
                const groupCheckboxes = document.querySelectorAll('.group-checkbox:checked');
                if (groupCheckboxes.length > 0) {
                    e.preventDefault(); // 防止默认行为
                    await batchDeleteFiles();
                }
            }
        });

        // 初始加载文件列表
        document.addEventListener('DOMContentLoaded', () => {
            // 刷新按钮事件
            document.getElementById('refreshBtn').addEventListener('click', loadFileList);

            // 全选按钮事件
            document.getElementById('selectAllBtn').addEventListener('click', toggleSelectAll);

            // 批量删除按钮事件
            document.getElementById('batchDeleteBtn').addEventListener('click', batchDeleteFiles);
        });

        // 监听窗口show事件，当窗口从隐藏状态重新显示时自动刷新文件列表
        if (window.__TAURI__ && window.__TAURI__.event) {
            // 监听来自main窗口的refresh-file-list自定义事件
            window.__TAURI__.event.listen('refresh-file-list', () => {
                console.log('Nyaser Maps Downloader: 收到刷新文件列表事件，开始刷新文件列表');
                loadFileList();
            });
        }
    </script>
</body>

</html>