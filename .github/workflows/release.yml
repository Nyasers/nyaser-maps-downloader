name: "Tauri Release"

on:
  push:
    # ä»…åœ¨æ¨é€ä»¥ 'v' å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘ (ä¾‹å¦‚ v1.6.7)
    tags:
      - 'v*'

jobs:
  release:
    # åªéœ€è¦åœ¨ Linux ç¯å¢ƒä¸‹è¿è¡Œï¼Œtauri-action ä¼šå¤„ç† Windows å’Œ macOS çš„äº¤å‰ç¼–è¯‘
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      # âš ï¸ å…³é”®æ­¥éª¤ï¼šè®¾ç½® Tauri ä¾èµ–
      - name: Setup Node.js and Rust
        uses: actions/setup-node@v4
        with:
          node-version: '20' # å»ºè®®ä½¿ç”¨ LTS ç‰ˆæœ¬

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: x86_64-pc-windows-msvc # å‡è®¾ä½ çš„ä¸»è¦ç›®æ ‡æ˜¯ Windows
      
      - name: Install Node dependencies
        run: npm install

      # âš ï¸ å…³é”®æ­¥éª¤ï¼šåœ¨ Actions ç¯å¢ƒä¸­åŠ è½½ .env å˜é‡
      # æ³¨æ„ï¼šç›´æ¥è¯»å– .env æ–‡ä»¶ä¸å®‰å…¨ï¼Œåº”å°†å…¶ä¸­çš„æ•æ„Ÿå˜é‡ä½œä¸º Secret ä¼ å…¥
      # è¿™é‡Œå‡è®¾ä½ åªéœ€è¦ TAURI_SIGNING_PRIVATE_KEY å’Œ TAURI_SIGNING_PRIVATE_KEY_PASSWORD
      - name: Set environment variables
        shell: bash
        run: |
          # å‡è®¾ä½ çš„ .env æ–‡ä»¶ä¸­çš„é”®å’Œå€¼å¯ä»¥ç›´æ¥ç”¨äº Shell
          # å¦‚æœä½ çš„æ„å»ºéœ€è¦æ›´å¤šçš„ .env å˜é‡ï¼Œè¯·åœ¨æ­¤å¤„è®¾ç½®
          echo "TAURI_SIGNING_PRIVATE_KEY=${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}" >> $GITHUB_ENV
          echo "TAURI_SIGNING_PRIVATE_KEY_PASSWORD=${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}" >> $GITHUB_ENV

      # ğŸš€ æ ¸å¿ƒæ­¥éª¤ï¼šä½¿ç”¨ tauri-action è‡ªåŠ¨æ„å»ºã€æ‰“åŒ…ã€ç­¾åå’Œåˆ›å»º GitHub Release
      - name: Build and Release Tauri App
        uses: tauri-apps/tauri-action@v0
        env:
          # å¿…é¡»å°† GitHub ä»¤ç‰Œä¼ å…¥ï¼Œä»¥ä¾¿ Action æœ‰æƒé™åˆ›å»º Release
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # å°†ä½ çš„æ„å»ºå‘½ä»¤ä¼ å…¥
          command: npm run tauri # è¿™é‡Œçš„ tauri è„šæœ¬åº”è¯¥åŒ…å« tauri build
          # å»ºè®®ä½¿ç”¨ tag åç§°ä½œä¸ºç‰ˆæœ¬å·
          tagName: ${{ github.ref_name }}
          releaseName: 'Release ${{ github.ref_name }}'
          releaseBody: 'See the changelog for details.' # æˆ–ä½¿ç”¨ä¸€ä¸ªæ–‡ä»¶æ¥ç”Ÿæˆè¯´æ˜
          prerelease: false
          
          # ç­¾åå¯†é’¥å’Œå¯†ç ä¼šä» GITHUB_ENV è‡ªåŠ¨è·å–
          # tauri-action ä¼šè‡ªåŠ¨æŸ¥æ‰¾ TAURI_SIGNING_PRIVATE_KEY å’Œ TAURI_SIGNING_PRIVATE_KEY_PASSWORD